<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV Monitoring System - Banda Aceh</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    
    <!-- HLS.js for video streaming -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/hls.js/1.4.10/hls.min.js"></script>
    <style>
        * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: 'Inter', sans-serif;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    overflow: hidden;
    position: relative;
    height: 100vh;
    width: 100vw;
}

body::before {
    content: '';
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: 
        radial-gradient(circle at 20% 20%, rgba(255,255,255,0.1) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255,255,255,0.08) 0%, transparent 50%);
    pointer-events: none;
    z-index: 1;
}

.container {
    display: flex;
    height: 100vh;
    width: 100vw;
    position: relative;
    z-index: 2;
}

.sidebar {
    width: 420px;
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(20px);
    box-shadow: 
        0 0 40px rgba(0, 0, 0, 0.1),
        inset 1px 0 0 rgba(255, 255, 255, 0.2);
    display: flex;
    flex-direction: column;
    position: relative;
    z-index: 1000;
    border-right: 1px solid rgba(255, 255, 255, 0.2);
}

.header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 30px 25px;
    text-align: center;
    position: relative;
    overflow: hidden;
}

.header::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: 
        radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
    background-size: 20px 20px;
    animation: float 20s ease-in-out infinite;
    opacity: 0.3;
}

@keyframes float {
    0%, 100% { transform: translate(0, 0) rotate(0deg); }
    33% { transform: translate(30px, -30px) rotate(120deg); }
    66% { transform: translate(-20px, 20px) rotate(240deg); }
}

.header h1 {
    font-size: 1.8rem;
    font-weight: 700;
    margin-bottom: 8px;
    position: relative;
    z-index: 1;
    text-shadow: 0 2px 10px rgba(0,0,0,0.2);
}

.header .subtitle {
    font-size: 0.9rem;
    opacity: 0.9;
    position: relative;
    z-index: 1;
    font-weight: 400;
}

.search-container {
    padding: 25px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.5);
}

.search-box {
    position: relative;
    display: flex;
    gap: 12px;
}

.search-input {
    flex: 1;
    padding: 15px 20px;
    border: 2px solid rgba(102, 126, 234, 0.2);
    border-radius: 50px;
    font-size: 14px;
    outline: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(10px);
    font-weight: 500;
}

.search-input:focus {
    border-color: #667eea;
    box-shadow: 
        0 0 0 4px rgba(102, 126, 234, 0.1),
        0 8px 25px rgba(102, 126, 234, 0.15);
    transform: translateY(-2px);
}

.search-input::placeholder {
    color: rgba(0,0,0,0.5);
    font-weight: 400;
}

.search-btn, .filter-btn {
    padding: 15px 20px;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
    position: relative;
    overflow: hidden;
}

.search-btn::before, .filter-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.search-btn:hover::before, .filter-btn:hover::before {
    left: 100%;
}

.search-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
}

.filter-btn {
    background: rgba(255,255,255,0.9);
    color: #495057;
    border: 2px solid rgba(102, 126, 234, 0.2);
    box-shadow: 0 4px 15px rgba(0,0,0,0.1);
}

.search-btn:hover, .filter-btn:hover {
    transform: translateY(-3px);
    box-shadow: 
        0 8px 25px rgba(102, 126, 234, 0.4),
        0 0 0 1px rgba(255,255,255,0.1);
}

.auth-container {
    padding: 25px;
    border-bottom: 1px solid rgba(0,0,0,0.08);
    background: rgba(255,255,255,0.3);
}

.auth-buttons {
    display: flex;
    gap: 12px;
}

.auth-btn {
    flex: 1;
    padding: 12px 16px;
    border: none;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
}

.auth-btn::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
    transition: left 0.5s;
}

.auth-btn:hover::before {
    left: 100%;
}

.login-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.admin-btn {
    background: linear-gradient(135deg, #fd7e14 0%, #e83e8c 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(253, 126, 20, 0.3);
}

.logout-btn {
    background: linear-gradient(135deg, #dc3545 0%, #fd7e14 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(220, 53, 69, 0.3);
}

.auth-btn:hover {
    transform: translateY(-2px);
    box-shadow: 
        0 8px 25px rgba(0,0,0,0.2),
        0 0 0 1px rgba(255,255,255,0.1);
}

#loggedInUser {
    background: rgba(255,255,255,0.9);
    padding: 15px;
    border-radius: 15px;
    backdrop-filter: blur(10px);
    border: 1px solid rgba(255,255,255,0.2);
}

.cctv-list {
    flex: 1;
    overflow-y: auto;
    padding: 15px;
    background: rgba(255,255,255,0.2);
}

.cctv-list::-webkit-scrollbar {
    width: 6px;
}

.cctv-list::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.1);
    border-radius: 3px;
}

.cctv-list::-webkit-scrollbar-thumb {
    background: rgba(102, 126, 234, 0.3);
    border-radius: 3px;
}

.cctv-list::-webkit-scrollbar-thumb:hover {
    background: rgba(102, 126, 234, 0.5);
}

.cctv-item {
    background: rgba(255,255,255,0.95);
    margin-bottom: 15px;
    padding: 20px;
    border-radius: 20px;
    box-shadow: 
        0 4px 20px rgba(0, 0, 0, 0.08),
        0 0 0 1px rgba(255,255,255,0.5);
    cursor: pointer;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.3);
}

.cctv-item::before {
    content: '';
    position: absolute;
    left: 0;
    top: 0;
    bottom: 0;
    width: 5px;
    background: linear-gradient(180deg, #667eea 0%, #764ba2 100%);
    border-radius: 0 10px 10px 0;
}

.cctv-item::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(135deg, rgba(255,255,255,0.1) 0%, transparent 50%);
    opacity: 0;
    transition: opacity 0.3s ease;
}

.cctv-item:hover {
    transform: translateY(-5px) scale(1.02);
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255,255,255,0.6);
}

.cctv-item:hover::after {
    opacity: 1;
}

.cctv-item.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    transform: translateY(-5px) scale(1.02);
    box-shadow: 
        0 15px 40px rgba(102, 126, 234, 0.3),
        0 0 0 1px rgba(255,255,255,0.3);
}

.cctv-name {
    font-weight: 600;
    font-size: 1.1rem;
    margin-bottom: 8px;
    color: inherit;
}

.cctv-location {
    font-size: 0.9rem;
    opacity: 0.8;
    margin-bottom: 12px;
    font-weight: 400;
}

.modal-center {
    display: flex;
    align-items: center;
    justify-content: center;
    min-height: 100vh;
    padding: 20px;
}

.modal-center .modal-content {
    margin: 0;
    width: 100%;
    max-width: 450px;
    animation: modalFadeIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

@keyframes modalFadeIn {
    from { 
        opacity: 0; 
        transform: scale(0.9) translateY(-20px); 
    }
    to { 
        opacity: 1; 
        transform: scale(1) translateY(0); 
    }
}

.cctv-status {
    display: inline-flex;
    align-items: center;
    padding: 6px 14px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    backdrop-filter: blur(10px);
}

.status-online {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.2) 0%, rgba(32, 201, 151, 0.2) 100%);
    color: #28a745;
    border: 1px solid rgba(40, 167, 69, 0.3);
}

.status-offline {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.2) 0%, rgba(253, 126, 20, 0.2) 100%);
    color: #dc3545;
    border: 1px solid rgba(220, 53, 69, 0.3);
}

.cctv-item.active .status-online,
.cctv-item.active .status-offline {
    background: rgba(255, 255, 255, 0.25);
    color: white;
    border: 1px solid rgba(255, 255, 255, 0.3);
}

.admin-controls {
    margin-top: 15px;
    display: none;
    gap: 8px;
}

.admin-controls button {
    z-index: 9999;
    position: relative;
    padding: 8px 14px;
    border: none;
    border-radius: 12px;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
}

.edit-btn {
    background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
    color: #212529;
    box-shadow: 0 2px 10px rgba(255, 193, 7, 0.3);
}

.delete-btn {
    background: linear-gradient(135deg, #dc3545 0%, #e83e8c 100%);
    color: white;
    box-shadow: 0 2px 10px rgba(220, 53, 69, 0.3);
}

.admin-controls button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

.map-container {
    flex: 1;
    position: relative;
    border-radius: 0 20px 20px 0;
    overflow: hidden;
    box-shadow: inset 0 0 0 1px rgba(255,255,255,0.2);
}

#map {
    width: 100%;
    height: 100%;
}

.add-cctv-btn {
    position: absolute;
    top: 25px;
    right: 25px;
    padding: 15px 20px;
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    border: none;
    border-radius: 50px;
    cursor: pointer;
    font-weight: 600;
    box-shadow: 
        0 8px 25px rgba(40, 167, 69, 0.3),
        0 0 0 1px rgba(255,255,255,0.2);
    z-index: 1000;
    display: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(20px);
}

.add-cctv-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 
        0 12px 35px rgba(40, 167, 69, 0.4),
        0 0 0 1px rgba(255,255,255,0.3);
}

.modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
}

.modal-content {
    background: rgba(255,255,255,0.95);
    margin: 5% auto;
    padding: 35px;
    border-radius: 25px;
    width: 90%;
    max-width: 500px;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255,255,255,0.2);
    animation: modalSlideIn 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.3);
}

@keyframes modalSlideIn {
    from {
        transform: translateY(-50px) scale(0.9);
        opacity: 0;
    }
    to {
        transform: translateY(0) scale(1);
        opacity: 1;
    }
}

.modal h2 {
    margin-bottom: 25px;
    color: #333;
    text-align: center;
    font-weight: 600;
    font-size: 1.5rem;
}

.form-group {
    margin-bottom: 20px;
}

.form-group label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #555;
    font-size: 0.9rem;
}

.form-group input, .form-group select {
    width: 100%;
    padding: 14px 18px;
    border: 2px solid rgba(102, 126, 234, 0.2);
    border-radius: 15px;
    font-size: 14px;
    outline: none;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(10px);
    font-weight: 500;
}

.form-group input:focus, .form-group select:focus {
    border-color: #667eea;
    box-shadow: 
        0 0 0 4px rgba(102, 126, 234, 0.1),
        0 4px 15px rgba(102, 126, 234, 0.15);
    transform: translateY(-2px);
}

.form-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;
    margin-top: 25px;
}

.form-buttons button {
    padding: 14px 28px;
    border: none;
    border-radius: 15px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
}

.save-btn {
    background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    color: white;
    box-shadow: 0 4px 15px rgba(40, 167, 69, 0.3);
}

.cancel-btn {
    background: rgba(108, 117, 125, 0.9);
    color: white;
    box-shadow: 0 4px 15px rgba(108, 117, 125, 0.3);
}

.form-buttons button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
}

.video-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.95);
    backdrop-filter: blur(10px);
}

.video-content {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 90%;
    max-width: 900px;
    background: rgba(255,255,255,0.95);
    border-radius: 20px;
    overflow: hidden;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.5),
        0 0 0 1px rgba(255,255,255,0.2);
    backdrop-filter: blur(20px);
}

.video-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 25px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}

.video-header h3 {
    font-weight: 600;
    font-size: 1.2rem;
}

.close-video {
    background: rgba(255,255,255,0.2);
    border: none;
    color: white;
    font-size: 24px;
    cursor: pointer;
    padding: 8px 12px;
    border-radius: 50%;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    backdrop-filter: blur(10px);
}

.close-video:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
}

#videoPlayer {
    width: 100%;
    height: 400px;
    background: #000;
}

.login-modal {
    display: none;
    position: fixed;
    z-index: 2000;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    backdrop-filter: blur(10px);
}

.loading {
    display: none;
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: rgba(255,255,255,0.95);
    padding: 30px;
    border-radius: 20px;
    box-shadow: 
        0 25px 80px rgba(0, 0, 0, 0.3),
        0 0 0 1px rgba(255,255,255,0.2);
    z-index: 3000;
    backdrop-filter: blur(20px);
    text-align: center;
}

.loading-spinner {
    border: 3px solid rgba(102, 126, 234, 0.2);
    border-top: 3px solid #667eea;
    border-radius: 50%;
    width: 40px;
    height: 40px;
    animation: spin 1s linear infinite;
    margin: 0 auto 15px;
}

@keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
}

.loading p {
    color: #333;
    font-weight: 500;
    margin: 0;
}

.leaflet-popup-content-wrapper {
    border-radius: 15px;
    box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
    backdrop-filter: blur(10px);
    background: rgba(255,255,255,0.95);
    border: 1px solid rgba(255,255,255,0.3);
}

.custom-popup {
    text-align: center;
    padding: 15px;
}

.custom-popup h3 {
    margin-bottom: 12px;
    color: #333;
    font-weight: 600;
}

.custom-popup p {
    margin-bottom: 8px;
    font-weight: 500;
}

.custom-popup .watch-btn {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border: none;
    padding: 12px 24px;
    border-radius: 25px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
    margin-top: 8px;
}

.custom-popup .watch-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
}

.stream-indicator {
    display: inline-block;
    width: 8px;
    height: 8px;
    border-radius: 50%;
    margin-left: 8px;
    animation: pulse 2s infinite;
    box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
}

.stream-live {
    background: #ff0000;
}

@keyframes pulse {
    0% { 
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 0, 0, 0.7);
    }
    70% {
        transform: scale(1.2);
        box-shadow: 0 0 0 10px rgba(255, 0, 0, 0);
    }
    100% {
        transform: scale(1);
        box-shadow: 0 0 0 0 rgba(255, 0, 0, 0);
    }
}

/* Filter Menu Enhanced */
.filter-menu {
    background: rgba(255,255,255,0.95) !important;
    backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    box-shadow: 
        0 15px 40px rgba(0, 0, 0, 0.15),
        0 0 0 1px rgba(255,255,255,0.2) !important;
}

.filter-menu h4 {
    color: #333;
    font-weight: 600;
}

.filter-menu select {
    border: 2px solid rgba(102, 126, 234, 0.2);
    border-radius: 10px;
    background: rgba(255,255,255,0.8);
    backdrop-filter: blur(10px);
}

.filter-menu button {
    border-radius: 10px;
    font-weight: 600;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.filter-menu button:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
}

/* Auth form links */
.modal-content a {
    color: #667eea;
    text-decoration: none;
    font-weight: 600;
    transition: color 0.3s ease;
}

.modal-content a:hover {
    color: #764ba2;
}

/* Additional styling for form inputs */
.form-group input::placeholder {
    color: rgba(0,0,0,0.5);
    font-weight: 400;
}

/* Enhanced notification styles */
.notification {
    position: fixed;
    top: 25px;
    right: 25px;
    padding: 18px 24px;
    border-radius: 15px;
    box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.12),
        0 0 0 1px rgba(255,255,255,0.2);
    z-index: 3000;
    font-weight: 600;
    max-width: 350px;
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.3);
    animation: slideInRight 0.4s cubic-bezier(0.4, 0, 0.2, 1);
}

.notification.success {
    background: linear-gradient(135deg, rgba(40, 167, 69, 0.95) 0%, rgba(32, 201, 151, 0.95) 100%);
    color: white;
}

.notification.error {
    background: linear-gradient(135deg, rgba(220, 53, 69, 0.95) 0%, rgba(253, 126, 20, 0.95) 100%);
    color: white;
}

.notification.info {
    background: linear-gradient(135deg, rgba(23, 162, 184, 0.95) 0%, rgba(102, 126, 234, 0.95) 100%);
    color: white;
}

@keyframes slideInRight {
    from { 
        transform: translateX(100%) scale(0.9); 
        opacity: 0; 
    }
    to { 
        transform: translateX(0) scale(1); 
        opacity: 1; 
    }
}

@keyframes slideOutRight {
    from { 
        transform: translateX(0) scale(1); 
        opacity: 1; 
    }
    to { 
        transform: translateX(100%) scale(0.9); 
        opacity: 0; 
    }
}

/* Enhanced marker styles */
.custom-marker div {
    border: 3px solid white !important;
    box-shadow: 
        0 4px 15px rgba(0,0,0,0.3),
        0 0 0 2px rgba(255,255,255,0.5) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.custom-marker:hover div {
    transform: scale(1.2) !important;
    box-shadow: 
        0 6px 20px rgba(0,0,0,0.4),
        0 0 0 3px rgba(255,255,255,0.7) !important;
}

/* Map control enhancements */
.leaflet-control-custom {
    background: rgba(255,255,255,0.95) !important;
    backdrop-filter: blur(20px) !important;
    border: 1px solid rgba(255,255,255,0.3) !important;
    border-radius: 10px !important;
    box-shadow: 0 4px 15px rgba(0,0,0,0.1) !important;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1) !important;
}

.leaflet-control-custom:hover {
    transform: translateY(-2px) !important;
    box-shadow: 0 6px 20px rgba(0,0,0,0.15) !important;
}

/* Scrollbar enhancement for webkit browsers */
* {
    scrollbar-width: thin;
    scrollbar-color: rgba(102, 126, 234, 0.3) rgba(255,255,255,0.1);
}

*::-webkit-scrollbar {
    width: 8px;
    height: 8px;
}

*::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.1);
    border-radius: 4px;
}

*::-webkit-scrollbar-thumb {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.5) 0%, rgba(118, 75, 162, 0.5) 100%);
    border-radius: 4px;
    border: 1px solid rgba(255,255,255,0.2);
}

*::-webkit-scrollbar-thumb:hover {
    background: linear-gradient(135deg, rgba(102, 126, 234, 0.7) 0%, rgba(118, 75, 162, 0.7) 100%);
}

/* RESPONSIVE DESIGN - MOBILE FIXES */
/* Mobile Large (640px - 767px) */
@media (max-width: 767px) {
    body {
        overflow: auto;
        height: auto;
        min-height: 100vh;
    }
    
    .container {
        flex-direction: column;
        height: auto;
        min-height: 100vh;
    }
    
    .sidebar {
        width: 100%;
        height: auto;
        border-radius: 0;
        border-right: none;
        border-bottom: 1px solid rgba(255, 255, 255, 0.2);
        flex-shrink: 0;
    }
    
    .header {
        padding: 18px 16px;
    }
    
    .header h1 {
        font-size: 1.4rem;
        margin-bottom: 5px;
    }
    
    .header .subtitle {
        font-size: 0.75rem;
    }
    
    .search-container,
    .auth-container {
        padding: 16px;
    }
    
    .search-box {
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .search-input {
        padding: 12px 16px;
        font-size: 14px;
        border-radius: 40px;
        min-width: 0;
        flex: 1;
    }
    
    .search-btn,
    .filter-btn {
        padding: 12px 16px;
        font-size: 14px;
        border-radius: 40px;
        white-space: nowrap;
        flex-shrink: 0;
    }
    
    .auth-buttons {
        gap: 8px;
    }
    
    .auth-btn {
        padding: 10px 16px;
        font-size: 0.9rem;
        border-radius: 20px;
    }
    
    .cctv-list {
        padding: 10px;
        max-height: 40vh;
        overflow-y: auto;
    }
    
    .cctv-item {
        padding: 12px;
        margin-bottom: 8px;
        border-radius: 14px;
    }
    
    .cctv-name {
        font-size: 0.9rem;
        margin-bottom: 5px;
    }
    
    .cctv-location {
        font-size: 0.75rem;
        margin-bottom: 8px;
    }
    
    .cctv-status {
        padding: 3px 8px;
        font-size: 0.65rem;
    }
    
    .admin-controls {
        margin-top: 8px;
        gap: 4px;
        flex-wrap: wrap;
    }
    
    .admin-controls button {
        padding: 5px 8px;
        font-size: 0.65rem;
        flex: 1;
        min-width: calc(50% - 2px);
    }
    
    .map-container {
        height: 60vh;
        min-height: 400px;
        border-radius: 0;
        flex: none;
        position: relative;
    }
    
    #map {
        width: 100%;
        height: 100%;
    }
    
    .add-cctv-btn {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 0.8rem;
        border-radius: 30px;
    }
    
    .modal {
        padding: 10px;
    }
    
    .modal-content,
    .modal-center .modal-content {
        margin: 0;
        padding: 20px;
        border-radius: 16px;
        max-width: none;
        width: 100%;
    }
    
    .modal h2 {
        font-size: 1.1rem;
        margin-bottom: 16px;
    }
    
    .form-group {
        margin-bottom: 14px;
    }
    
    .form-group label {
        font-size: 0.8rem;
        margin-bottom: 5px;
    }
    
    .form-group input,
    .form-group select {
        padding: 10px 14px;
        font-size: 14px;
        border-radius: 10px;
    }
    
    .form-buttons {
        gap: 8px;
        margin-top: 16px;
        justify-content: stretch;
        flex-direction: column;
    }
    
    .form-buttons button {
        flex: 1;
        padding: 12px 16px;
        font-size: 0.9rem;
        border-radius: 10px;
        width: 100%;
    }
    
    .video-content {
        width: 98%;
        border-radius: 12px;
    }
    
    .video-header {
        padding: 12px 16px;
    }
    
    .video-header h3 {
        font-size: 1rem;
    }
    
    .close-video {
        padding: 6px 10px;
        font-size: 20px;
    }
    
    #videoPlayer {
        height: 280px;
    }
    
    .notification {
        top: 10px;
        right: 10px;
        left: 10px;
        max-width: none;
        padding: 12px 16px;
        font-size: 0.85rem;
        border-radius: 10px;
    }
    
    .loading {
        padding: 20px;
        border-radius: 16px;
    }
    
    .loading-spinner {
        width: 32px;
        height: 32px;
        margin-bottom: 12px;
    }
}

/* Mobile Small (480px - 639px) */
@media (max-width: 639px) {
    .search-box {
        flex-direction: column;
        gap: 8px;
    }
    
    .search-input {
        width: 100%;
        padding: 10px 14px;
        font-size: 13px;
    }
    
    .search-btn,
    .filter-btn {
        width: 100%;
        padding: 10px 14px;
        font-size: 13px;
        justify-content: center;
    }
    
    .auth-buttons {
        flex-direction: column;
        gap: 6px;
    }
    
    .auth-btn {
        width: 100%;
        padding: 10px 14px;
        font-size: 0.85rem;
    }
    
    .cctv-list {
        max-height: 35vh;
    }
    
    .cctv-item {
        padding: 10px;
        margin-bottom: 6px;
    }
    
    .admin-controls {
        flex-direction: column;
        gap: 4px;
    }
    
    .admin-controls button {
        width: 100%;
        padding: 6px 10px;
    }
    
    .map-container {
        height: 65vh;
    }
    
    #videoPlayer {
        height: 240px;
    }
}

/* Mobile Very Small (320px - 479px) */
@media (max-width: 479px) {
    .header {
        padding: 14px 12px;
    }
    
    .header h1 {
        font-size: 1.2rem;
    }
    
    .header .subtitle {
        font-size: 0.7rem;
    }
    
    .search-container,
    .auth-container {
        padding: 12px;
    }
    
    .search-input {
        padding: 9px 12px;
        font-size: 12px;
    }
    
    .search-btn,
    .filter-btn {
        padding: 9px 12px;
        font-size: 12px;
    }
    
    .auth-btn {
        padding: 8px 12px;
        font-size: 0.8rem;
    }
    
    .cctv-list {
        padding: 8px;
        max-height: 30vh;
    }
    
    .cctv-item {
        padding: 8px;
        margin-bottom: 5px;
        border-radius: 10px;
    }
    
    .cctv-name {
        font-size: 0.85rem;
        margin-bottom: 4px;
    }
    
    .cctv-location {
        font-size: 0.7rem;
        margin-bottom: 6px;
    }
    
    .cctv-status {
        padding: 2px 6px;
        font-size: 0.6rem;
    }
    
    .admin-controls button {
        padding: 5px 8px;
        font-size: 0.6rem;
    }
    
    .map-container {
        height: 70vh;
        min-height: 350px;
    }
    
    .add-cctv-btn {
        top: 8px;
        right: 8px;
        padding: 6px 10px;
        font-size: 0.75rem;
    }
    
    .modal {
        padding: 8px;
    }
    
    .modal-content {
        padding: 16px;
        border-radius: 12px;
    }
    
    .modal h2 {
        font-size: 1rem;
        margin-bottom: 12px;
    }
    
    .form-group {
        margin-bottom: 12px;
    }
    
    .form-group label {
        font-size: 0.75rem;
        margin-bottom: 4px;
    }
    
    .form-group input,
    .form-group select {
        padding: 8px 12px;
        font-size: 12px;
        border-radius: 8px;
    }
    
    .form-buttons {
        gap: 6px;
        margin-top: 12px;
    }
    
    .form-buttons button {
        padding: 10px 14px;
        font-size: 0.8rem;
        border-radius: 8px;
        margin-bottom: 6px;
    }
    
    .video-content {
        width: 100%;
        border-radius: 8px;
        margin: 10px;
        width: calc(100% - 20px);
    }
    
    .video-header {
        padding: 10px 12px;
    }
    
    .video-header h3 {
        font-size: 0.9rem;
    }
    
    .close-video {
        padding: 4px 8px;
        font-size: 18px;
    }
    
    #videoPlayer {
        height: 200px;
    }
    
    .notification {
        top: 8px;
        right: 8px;
        left: 8px;
        padding: 10px 12px;
        font-size: 0.8rem;
        border-radius: 8px;
    }
    
    .loading {
        padding: 16px;
        border-radius: 12px;
    }
    
    .loading-spinner {
        width: 28px;
        height: 28px;
        margin-bottom: 10px;
    }
}

/* Landscape orientation for mobile */
@media (max-width: 767px) and (orientation: landscape) {
    .container {
        flex-direction: row;
    }
    
    .sidebar {
        width: 300px;
        height: 100vh;
        border-right: 1px solid rgba(255, 255, 255, 0.2);
        border-bottom: none;
    }
    
    .cctv-list {
        max-height: none;
        flex: 1;
    }
    
    .map-container {
        height: 100vh;
        flex: 1;
    }
    
    .header {
        padding: 12px 10px;
    }
    
    .header h1 {
        font-size: 1.1rem;
        margin-bottom: 3px;
    }
    
    .header .subtitle {
        font-size: 0.65rem;
    }
    
    .search-container,
    .auth-container {
        padding: 10px;
    }
    
    .cctv-item {
        padding: 8px;
        margin-bottom: 4px;
    }
}

/* Tablet responsive fixes */
@media (min-width: 768px) and (max-width: 1023px) {
    .sidebar {
        width: 340px;
    }
    
    .map-container {
        flex: 1;
    }
    
    #map {
        width: 100%;
        height: 100%;
    }
}

/* Desktop responsive */
@media (min-width: 1024px) {
    .sidebar {
        width: 420px;
    }
    
    .map-container {
        flex: 1;
        border-radius: 0 20px 20px 0;
    }
    
    #map {
        width: 100%;
        height: 100%;
    }
}

/* High DPI displays */
@media (-webkit-min-device-pixel-ratio: 2), (min-resolution: 192dpi) {
    .loading-spinner {
        border-width: 2px;
    }
    
    .cctv-item::before {
        width: 4px;
    }
    
    *::-webkit-scrollbar {
        width: 6px;
        height: 6px;
    }
}

/* Touch device optimizations */
@media (pointer: coarse) {
    .search-btn,
    .filter-btn,
    .auth-btn,
    .admin-controls button,
    .form-buttons button,
    .add-cctv-btn,
    .close-video {
        min-height: 44px;
        min-width: 44px;
    }
    
    .cctv-item {
        min-height: 60px;
    }
    
    .search-input,
    .form-group input,
    .form-group select {
        min-height: 44px;
    }
}

/* Reduced motion preferences */
@media (prefers-reduced-motion: reduce) {
    *,
    *::before,
    *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
    
    .header::before {
        animation: none;
    }
    
    .stream-indicator {
        animation: none;
    }
    
    .loading-spinner {
        animation: none;
        border: 3px solid #667eea;
        border-top: 3px solid rgba(102, 126, 234, 0.2);
    }
}

/* Print styles */
@media print {
    body::before,
    .video-modal,
    .modal,
    .loading,
    .notification,
    .add-cctv-btn,
    .admin-controls {
        display: none !important;
    }
    
    .container {
        flex-direction: column;
        height: auto;
    }
    
    .sidebar,
    .map-container {
        width: 100%;
        height: auto;
        box-shadow: none;
        border: 1px solid #ddd;
    }
    
    .cctv-item {
        break-inside: avoid;
        page-break-inside: avoid;
    }
}
    </style>
</head>
<body>
    <div class="container">
        <div class="sidebar">
            <div class="header">
                <h1>CCTV MONITORING</h1>
                <div class="subtitle">Banda Aceh Smart City</div>
            </div>

    <div class="auth-container">

    <div class="auth-buttons" id="authButtons">
        <button class="auth-btn login-btn" onclick="showLoginModal()">Login</button>
        <button class="auth-btn admin-btn" onclick="showRegisterModal()">Daftar</button>
                </div>
                <div id="loggedInUser" style="display: none;">
                    <div style="margin-bottom: 10px;">
                        <strong>Selamat datang, <span id="userName"></span>!</strong>
                        <span id="userRole" style="background: #667eea; color: white; padding: 2px 8px; border-radius: 10px; font-size: 0.75rem; margin-left: 5px;"></span>
                    </div>
                    <button class="auth-btn logout-btn" onclick="logout()">Logout</button>
                </div>
            </div>
            <!-- Search -->
            <div class="search-container">
                <div class="search-box">
                    <input type="text" class="search-input" placeholder="Cari CCTV..." id="searchInput">
                    <button class="search-btn" onclick="searchCCTV()">üîç</button>
                    <button class="filter-btn" onclick="toggleFilter()">‚öôÔ∏è</button>
                </div>
            </div>

            <!-- CCTV List -->
            <div class="cctv-list" id="cctvList">
                <!-- CCTV items will be populated here -->
            </div>
        </div>

        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
            <button class="add-cctv-btn" id="addCctvBtn" onclick="showAddCctvModal()">+ Tambah CCTV</button>
        </div>
    </div>

    <!-- Login Modal -->
    <div class="modal" id="loginModal">
        <div class="modal-center">
            <div class="modal-content">
                <h2>Login ke Sistem</h2>
                <form id="loginForm">
                    <div class="form-group">
                        <label for="loginEmail">Email:</label>
                        <input type="email" id="loginEmail" required value="admin@example.com">
                    </div>
                    <div class="form-group">
                        <label for="loginPassword">Password:</label>
                        <input type="password" id="loginPassword" required value="123456">
                    </div>
                    <div class="form-buttons">
                        <button type="button" class="cancel-btn" onclick="closeLoginModal()">Batal</button>
                        <button type="submit" class="save-btn">Login</button>
                    </div>
                    <div style="text-align: center; margin-top: 15px;">
                        Belum punya akun? <a href="javascript:void(0)" onclick="switchToRegister()">Daftar disini</a>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="modal" id="registerModal">
        <div class="modal-center">
             <div class="modal-content">
                <h2>Daftar Akun Baru</h2>
                    <form id="registerForm">
                            <div class="form-group">
                                <label for="registerName">Nama Lengkap:</label>
                                <input type="text" id="registerName" required>
                            </div>
                            <div class="form-group">
                                <label for="registerEmail">Email:</label>
                                <input type="email" id="registerEmail" required>
                            </div>
                            <div class="form-group">
                                <label for="registerPassword">Password:</label>
                                <input type="password" id="registerPassword" required>
                            </div>
                            <div class="form-group">
                                <label for="registerConfirmPassword">Konfirmasi Password:</label>
                                <input type="password" id="registerConfirmPassword" required>
                            </div>
                            <div class="form-buttons">
                                <button type="button" class="cancel-btn" onclick="closeRegisterModal()">Batal</button>
                                <button type="submit" class="save-btn">Daftar</button>
                            </div>
                            <div style="text-align: center; margin-top: 15px;">
                                Sudah punya akun? <a href="javascript:void(0)" onclick="switchToLogin()">Login disini</a>
                            </div>
                        </form>
            </div>
        </div>
    </div>

    <!-- Add/Edit CCTV Modal -->
    <div class="modal" id="cctvModal">
        <div class="modal-content">
            <h2 id="modalTitle">Tambah CCTV Baru</h2>
            <form id="cctvForm">
                <div class="form-group">
                    <label for="cctvName">Nama CCTV:</label>
                    <input type="text" id="cctvName" required>
                </div>
                <div class="form-group">
                    <label for="cctvLocation">Lokasi:</label>
                    <input type="text" id="cctvLocation" required>
                </div>
                <div class="form-group">
                    <label for="cctvLat">Latitude:</label>
                    <input type="number" id="cctvLat" step="any" required>
                </div>
                <div class="form-group">
                    <label for="cctvLng">Longitude:</label>
                    <input type="number" id="cctvLng" step="any" required>
                </div>
                <div class="form-group">
                    <label for="cctvStream">Stream URL (HLS/m3u8):</label>
                    <input type="url" id="cctvStream" placeholder="https://example.com/stream.m3u8">
                </div>
                <div class="form-group">
                    <label for="cctvDescription">Deskripsi:</label>
                    <input type="text" id="cctvDescription" placeholder="Deskripsi CCTV">
                </div>
                <div class="form-group">
                    <label for="cctvStatus">Status:</label>
                    <select id="cctvStatus">
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
                <div class="form-buttons">
                    <button type="button" class="cancel-btn" onclick="closeCctvModal()">Batal</button>
                    <button type="submit" class="save-btn">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Video Player Modal -->
    <div class="video-modal" id="videoModal">
        <div class="video-content">
            <div class="video-header">
                <h3 id="videoTitle">Live Stream CCTV</h3>
                <button class="close-video" onclick="closeVideoModal()">&times;</button>
            </div>
            <video id="videoPlayer" controls autoplay muted></video>
        </div>
    </div>

    <!-- Loading Modal -->
    <div class="loading" id="loadingModal">
        <div class="loading-spinner"></div>
        <div>Loading...</div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.js"></script>
    
    <script>
                let map;
        let cctvData = [];
        let markers = [];
        let currentUser = null;
        let editingCctvId = null;
        let authToken = localStorage.getItem('authToken');

        // API Configuration
        const API_BASE = 'https://banda-aceh-cctv-monitoring-system.vercel.app/api';
        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initMap();
            checkAuthStatus();
            loadCCTVData();
            setupEventListeners();
        });

        // API Helper Functions
        async function apiRequest(url, options = {}) {
            const defaultHeaders = {
                'Content-Type': 'application/json',
            };

            if (authToken) {
                defaultHeaders.Authorization = `Bearer ${authToken}`;
            }

            const config = {
                ...options,
                headers: {
                    ...defaultHeaders,
                    ...options.headers,
                },
            };

            try {
                const response = await fetch(`${API_BASE}${url}`, config);
                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'API request failed');
                }

                return data;
            } catch (error) {
                console.error('API Error:', error);
                throw error;
            }
        }

        // Auth Functions
        async function login(email, password) {
            try {
                showLoading(true);
                const data = await apiRequest('/auth/login', {
                    method: 'POST',
                    body: JSON.stringify({ email, password }),
                });

                authToken = data.token;
                localStorage.setItem('authToken', authToken);
                currentUser = data.user;
                
                updateAuthUI();
                closeLoginModal();
                await loadCCTVData();
                showNotification('Login berhasil!', 'success');
            } catch (error) {
                showNotification('Login gagal: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function logout() {
            authToken = null;
            currentUser = null;
            localStorage.removeItem('authToken');
            document.getElementById('addCctvBtn').style.display = 'none';
            updateAuthUI();
            loadCCTVData();
            showNotification('Logout berhasil', 'info');
        }

        // Modal Functions
        function showRegisterModal() {
            document.getElementById('registerModal').style.display = 'block';
            document.getElementById('registerForm').reset();
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').style.display = 'none';
        }

        async function register(name, email, password, confirmPassword) {
            if (password !== confirmPassword) {
                showNotification('Password dan konfirmasi password tidak cocok', 'error');
                return;
            }

            try {
                showLoading(true);
                const data = await apiRequest('/auth/register', {
                    method: 'POST',
                    body: JSON.stringify({ name, email, password }),
                });

                showNotification('Pendaftaran berhasil! Silakan login.', 'success');
                closeRegisterModal();
                showLoginModal();
            } catch (error) {
                showNotification('Pendaftaran gagal: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        function checkAuthStatus() {
            if (authToken) {
                // Validate token by making a request
                apiRequest('/cameras')
                    .then(() => {
                        // Token is valid, get user info from token
                        try {
                            const payload = JSON.parse(atob(authToken.split('.')[1]));
                            currentUser = { 
                                id: payload.id, 
                                role: payload.role,
                                name: payload.role === 'admin' ? 'Administrator' : 'User'
                            };
                            updateAuthUI();
                            if (currentUser.role === 'admin') {
                                document.getElementById('addCctvBtn').style.display = 'block';
                            }
                        } catch (e) {
                            logout();
                        }
                    })
                    .catch(() => {
                        logout();
                    });
            }
        }

        // CCTV Data Functions
        async function loadCCTVData() {
            try {
                if (!authToken) {
                    cctvData = [];
                    renderCctvList();
                    addMarkersToMap();
                    return;
                }

                showLoading(true);
                const response = await apiRequest('/cameras');
                cctvData = response.data.map(camera => ({
                    id: camera._id,
                    name: camera.name,
                    location: camera.location,
                    lat: camera.latitude,
                    lng: camera.longitude,
                    status: camera.status,
                    streamUrl: camera.streamUrl,
                    description: camera.description,
                }));

                renderCctvList();
                addMarkersToMap();
            } catch (error) {
                console.error('Failed to load CCTV data:', error);
                showNotification('Gagal memuat data CCTV', 'error');
            } finally {
                showLoading(false);
            }
        }

        async function saveCctv() {
            try {
                const formData = {
                    name: document.getElementById('cctvName').value,
                    location: document.getElementById('cctvLocation').value,
                    latitude: parseFloat(document.getElementById('cctvLat').value),
                    longitude: parseFloat(document.getElementById('cctvLng').value),
                    streamUrl: document.getElementById('cctvStream').value,
                    status: document.getElementById('cctvStatus').value,
                    description: document.getElementById('cctvDescription').value,
                };

                showLoading(true);

                if (editingCctvId) {
                    // Update existing CCTV
                    await apiRequest(`/cameras/${editingCctvId}`, {
                        method: 'PUT',
                        body: JSON.stringify(formData),
                    });
                    showNotification('CCTV berhasil diperbarui!', 'success');
                } else {
                    // Add new CCTV
                    await apiRequest('/cameras', {
                        method: 'POST',
                        body: JSON.stringify(formData),
                    });
                    showNotification('CCTV berhasil ditambahkan!', 'success');
                }

                await loadCCTVData();
                closeCctvModal();
            } catch (error) {
                showNotification('Gagal menyimpan CCTV: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        async function deleteCctv(id) {
            if (!confirm('Apakah Anda yakin ingin menghapus CCTV ini?')) {
                return;
            }

            try {
                showLoading(true);
                await apiRequest(`/cameras/${id}`, {
                    method: 'DELETE',
                });

                await loadCCTVData();
                showNotification('CCTV berhasil dihapus!', 'success');
            } catch (error) {
                showNotification('Gagal menghapus CCTV: ' + error.message, 'error');
            } finally {
                showLoading(false);
            }
        }

        // Initialize Leaflet map
        function initMap() {
            // Center on Banda Aceh
            map = L.map('map').setView([5.5483, 95.3238], 13);

            // Add tile layer
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);

            // Handle map clicks for adding new CCTV (admin only)
            map.on('click', function(e) {
                if (currentUser && currentUser.role === 'admin') {
                    document.getElementById('cctvLat').value = e.latlng.lat.toFixed(6);
                    document.getElementById('cctvLng').value = e.latlng.lng.toFixed(6);
                }
            });
        }

        // Add markers to map
        function addMarkersToMap() {
            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            cctvData.forEach(cctv => {
                const iconColor = cctv.status === 'online' ? 'green' : 'red';
                
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${iconColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([cctv.lat, cctv.lng], { icon: customIcon }).addTo(map);

                const popupContent = `
                    <div class="custom-popup">
                        <h3>${cctv.name}</h3>
                        <p><strong>Lokasi:</strong> ${cctv.location}</p>
                        <p><strong>Status:</strong> <span style="color: ${iconColor}; font-weight: bold;">${cctv.status.toUpperCase()}</span></p>
                        ${cctv.status === 'online' && cctv.streamUrl ? 
                            `<button class="watch-btn" onclick="playVideo('${cctv.id}')">üî¥ Tonton Live</button>` : 
                            '<p style="color: red;">Stream tidak tersedia</p>'
                        }
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.on('click', () => selectCctv(cctv.id));
                
                markers.push(marker);
            });
        }

        // Render CCTV list in sidebar
        function renderCctvList() {
            const listContainer = document.getElementById('cctvList');
            
            if (!authToken) {
                listContainer.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Silakan login untuk melihat daftar CCTV</div>';
                return;
            }

            const searchQuery = document.getElementById('searchInput').value.toLowerCase();
            
            let filteredData = cctvData;
            if (searchQuery) {
                filteredData = cctvData.filter(cctv => 
                    cctv.name.toLowerCase().includes(searchQuery) ||
                    cctv.location.toLowerCase().includes(searchQuery)
                );
            }

            listContainer.innerHTML = filteredData.map(cctv => `
                <div class="cctv-item" onclick="selectCctv('${cctv.id}')" id="cctv-item-${cctv.id}">
                    <div class="cctv-name">${cctv.name}</div>
                    <div class="cctv-location">${cctv.location}</div>
                    <span class="cctv-status status-${cctv.status}">
                        ${cctv.status}
                        ${cctv.status === 'online' && cctv.streamUrl ? '<span class="stream-indicator stream-live"></span>' : ''}
                    </span>
                    ${currentUser && currentUser.role === 'admin' ? `
                        <div class="admin-controls" style="display: block;">
                            <button class="edit-btn" onclick="event.stopPropagation(); editCctv('${cctv.id}')">Edit</button>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteCctv('${cctv.id}')">Hapus</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // Select CCTV
        function selectCctv(id) {
            // Remove active class from all items
            document.querySelectorAll('.cctv-item').forEach(item => {
                item.classList.remove('active');
            });

            // Add active class to selected item
            const selectedItem = document.getElementById(`cctv-item-${id}`);
            if (selectedItem) {
                selectedItem.classList.add('active');
            }

            // Center map on selected CCTV
            const cctv = cctvData.find(c => c.id === id);
            if (cctv) {
                map.setView([cctv.lat, cctv.lng], 16);
                
                // Open popup for the marker
                const marker = markers.find(m => 
                    m.getLatLng().lat === cctv.lat && m.getLatLng().lng === cctv.lng
                );
                if (marker) {
                    marker.openPopup();
                }
            }
        }

    function switchToRegister() {
        closeLoginModal();
        showRegisterModal();
    }

    function switchToLogin() {
        closeRegisterModal();
        showLoginModal();
    }

        // Modal Functions
        function showLoginModal() {
            document.getElementById('loginModal').style.display = 'block';
        }

        function closeLoginModal() {
            document.getElementById('loginModal').style.display = 'none';
        }

        function showRegisterModal() {
            document.getElementById('registerModal').style.display = 'block';
        }

        function closeRegisterModal() {
            document.getElementById('registerModal').style.display = 'none';
        }

        function showAddCctvModal() {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Akses ditolak! Hanya admin yang dapat menambah CCTV.', 'error');
                return;
            }

            editingCctvId = null;
            document.getElementById('modalTitle').textContent = 'Tambah CCTV Baru';
            document.getElementById('cctvForm').reset();
            document.getElementById('cctvModal').style.display = 'block';
        }

        function editCctv(id) {
            if (!currentUser || currentUser.role !== 'admin') {
                showNotification('Akses ditolak! Hanya admin yang dapat mengedit CCTV.', 'error');
                return;
            }

            const cctv = cctvData.find(c => c.id === id);
            if (!cctv) return;

            editingCctvId = id;
            document.getElementById('modalTitle').textContent = 'Edit CCTV';
            document.getElementById('cctvName').value = cctv.name;
            document.getElementById('cctvLocation').value = cctv.location;
            document.getElementById('cctvLat').value = cctv.lat;
            document.getElementById('cctvLng').value = cctv.lng;
            document.getElementById('cctvStream').value = cctv.streamUrl || '';
            document.getElementById('cctvDescription').value = cctv.description || '';
            document.getElementById('cctvStatus').value = cctv.status;
            document.getElementById('cctvModal').style.display = 'block';
        }

        function closeCctvModal() {
            document.getElementById('cctvModal').style.display = 'none';
            editingCctvId = null;
        }

        function updateAuthUI() {
            const authButtons = document.getElementById('authButtons');
            const loggedInUser = document.getElementById('loggedInUser');

            if (currentUser) {
                authButtons.style.display = 'none';
                loggedInUser.style.display = 'block';
                document.getElementById('userName').textContent = currentUser.name;
                document.getElementById('userRole').textContent = currentUser.role.toUpperCase();
            } else {
                authButtons.style.display = 'flex';
                loggedInUser.style.display = 'none';
            }
        }

        // Video player functions
        function playVideo(id) {
            const cctv = cctvData.find(c => c.id === id);
            if (!cctv || !cctv.streamUrl) {
                showNotification('Stream tidak tersedia untuk CCTV ini.', 'error');
                return;
            }

            document.getElementById('videoTitle').textContent = `üî¥ Live Stream - ${cctv.name}`;
            document.getElementById('videoModal').style.display = 'block';

            const video = document.getElementById('videoPlayer');
            
            // Reset video element
            video.pause();
            video.src = '';
            
            // Check if HLS is supported
            if (Hls.isSupported()) {
                // Destroy existing HLS instance if any
                if (video.hlsInstance) {
                    video.hlsInstance.destroy();
                }
                
                const hls = new Hls({
                    debug: false,
                    enableWorker: true,
                    lowLatencyMode: true,
                    backBufferLength: 90
                });
                
                hls.loadSource(cctv.streamUrl);
                hls.attachMedia(video);
                
                hls.on(Hls.Events.MANIFEST_PARSED, function() {
                    console.log('Stream manifest loaded for:', cctv.name);
                    video.play().catch(e => {
                        console.log('Autoplay prevented:', e);
                        showNotification('Klik tombol play untuk memulai stream', 'info');
                    });
                });

                hls.on(Hls.Events.ERROR, function(event, data) {
                    console.error('HLS Error:', data);
                    if (data.fatal) {
                        showNotification('Gagal memuat stream. Mencoba reconnect...', 'error');
                        setTimeout(() => {
                            hls.loadSource(cctv.streamUrl);
                        }, 3000);
                    }
                });
                
                // Store hls instance for cleanup
                video.hlsInstance = hls;
            } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
                // Native HLS support (Safari)
                video.src = cctv.streamUrl;
                video.addEventListener('loadedmetadata', function() {
                    video.play().catch(e => {
                        console.log('Autoplay prevented:', e);
                        showNotification('Klik tombol play untuk memulai stream', 'info');
                    });
                });
            } else {
                showNotification('Browser Anda tidak mendukung streaming HLS.', 'error');
            }
        }

        function closeVideoModal() {
            const video = document.getElementById('videoPlayer');
            
            // Cleanup HLS instance
            if (video.hlsInstance) {
                video.hlsInstance.destroy();
                video.hlsInstance = null;
            }
            
            video.pause();
            video.src = '';
            document.getElementById('videoModal').style.display = 'none';
        }

        // Search functionality
        function searchCCTV() {
            renderCctvList();
        }

        // Loading functions
        function showLoading(show) {
            document.getElementById('loadingModal').style.display = show ? 'block' : 'none';
        }

        // Event Listeners
        // Event Listeners
        function setupEventListeners() {
            // Login form
            document.getElementById('loginForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                await login(email, password);
            });

            // Register form
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                const name = document.getElementById('registerName').value;
                const email = document.getElementById('registerEmail').value;
                const password = document.getElementById('registerPassword').value;
                const confirmPassword = document.getElementById('registerConfirmPassword').value;
                await register(name, email, password, confirmPassword);
            });

            // CCTV form
            document.getElementById('cctvForm').addEventListener('submit', function(e) {
                e.preventDefault();
                saveCctv();
            });

            // Search input
            document.getElementById('searchInput').addEventListener('input', searchCCTV);

            // Close modals when clicking outside
            document.getElementById('cctvModal').addEventListener('click', function(e) {
                if (e.target === this) closeCctvModal();
            });

            document.getElementById('videoModal').addEventListener('click', function(e) {
                if (e.target === this) closeVideoModal();
            });

            document.getElementById('loginModal').addEventListener('click', function(e) {
                if (e.target === this) closeLoginModal();
            });

            document.getElementById('registerModal').addEventListener('click', function(e) {
                if (e.target === this) closeRegisterModal();
            });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
            closeCctvModal();
            closeVideoModal();
            closeLoginModal();
            closeRegisterModal();
        }
    });
}
        // Filter functionality
        function toggleFilter() {
            const filterMenu = document.createElement('div');
            filterMenu.style.cssText = `
                position: absolute;
                top: 60px;
                right: 20px;
                background: white;
                padding: 20px;
                border-radius: 15px;
                box-shadow: 0 10px 30px rgba(0,0,0,0.2);
                z-index: 1500;
                min-width: 200px;
            `;
            
            filterMenu.innerHTML = `
                <h4 style="margin-bottom: 15px;">Filter CCTV</h4>
                <div style="margin-bottom: 10px;">
                    <label style="display: block; margin-bottom: 5px;">Status:</label>
                    <select id="statusFilter" style="width: 100%; padding: 5px; border-radius: 5px;">
                        <option value="all">Semua</option>
                        <option value="online">Online</option>
                        <option value="offline">Offline</option>
                    </select>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px;">Kecamatan:</label>
                    <select id="locationFilter" style="width: 100%; padding: 5px; border-radius: 5px;">
                        <option value="all">Semua</option>
                        <option value="BAITURRAHMAN">Baiturrahman</option>
                        <option value="KUTA ALAM">Kuta Alam</option>
                    </select>
                </div>
                <div style="display: flex; gap: 10px;">
                    <button onclick="applyFilters()" style="flex: 1; padding: 8px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">Terapkan</button>
                    <button onclick="clearFilters()" style="flex: 1; padding: 8px; background: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer;">Reset</button>
                </div>
            `;

            // Remove existing filter menu
            const existing = document.querySelector('.filter-menu');
            if (existing) {
                existing.remove();
                return;
            }

            filterMenu.className = 'filter-menu';
            document.querySelector('.search-container').appendChild(filterMenu);

            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', function closeFilter(e) {
                    if (!filterMenu.contains(e.target) && !e.target.classList.contains('filter-btn')) {
                        filterMenu.remove();
                        document.removeEventListener('click', closeFilter);
                    }
                });
            }, 100);
        }

        // Filter functions
        function applyFilters() {
            const statusFilter = document.getElementById('statusFilter').value;
            const locationFilter = document.getElementById('locationFilter').value;
            const searchQuery = document.getElementById('searchInput').value.toLowerCase();

            let filteredData = cctvData.filter(cctv => {
                const matchSearch = !searchQuery || 
                    cctv.name.toLowerCase().includes(searchQuery) ||
                    cctv.location.toLowerCase().includes(searchQuery);
                
                const matchStatus = statusFilter === 'all' || cctv.status === statusFilter;
                const matchLocation = locationFilter === 'all' || 
                    cctv.location.toUpperCase().includes(locationFilter);

                return matchSearch && matchStatus && matchLocation;
            });

            renderFilteredList(filteredData);
            updateMapMarkers(filteredData);
            
            document.querySelector('.filter-menu').remove();
        }

        function clearFilters() {
            document.getElementById('searchInput').value = '';
            renderCctvList();
            addMarkersToMap();
            document.querySelector('.filter-menu').remove();
        }

        function renderFilteredList(data) {
            const listContainer = document.getElementById('cctvList');
            
            listContainer.innerHTML = data.map(cctv => `
                <div class="cctv-item" onclick="selectCctv('${cctv.id}')" id="cctv-item-${cctv.id}">
                    <div class="cctv-name">${cctv.name}</div>
                    <div class="cctv-location">${cctv.location}</div>
                    <span class="cctv-status status-${cctv.status}">
                        ${cctv.status}
                        ${cctv.status === 'online' && cctv.streamUrl ? '<span class="stream-indicator stream-live"></span>' : ''}
                    </span>
                    ${currentUser && currentUser.role === 'admin' ? `
                        <div class="admin-controls" style="display: block;">
                            <button class="edit-btn" onclick="event.stopPropagation(); editCctv('${cctv.id}')">Edit</button>
                            <button class="delete-btn" onclick="event.stopPropagation(); deleteCctv('${cctv.id}')">Hapus</button>
                        </div>
                    ` : ''}
                </div>
            `).join('');

            // Show count
            const countInfo = document.createElement('div');
            countInfo.style.cssText = 'padding: 10px; font-size: 0.85rem; color: #666; text-align: center;';
            countInfo.textContent = `Menampilkan ${data.length} dari ${cctvData.length} CCTV`;
            listContainer.insertBefore(countInfo, listContainer.firstChild);
        }

        function updateMapMarkers(filteredData) {
            // Hide all markers first
            markers.forEach(marker => map.removeLayer(marker));
            
            // Show only filtered markers
            const filteredMarkers = [];
            filteredData.forEach(cctv => {
                const iconColor = cctv.status === 'online' ? 'green' : 'red';
                
                const customIcon = L.divIcon({
                    className: 'custom-marker',
                    html: `<div style="background: ${iconColor}; width: 20px; height: 20px; border-radius: 50%; border: 3px solid white; box-shadow: 0 2px 10px rgba(0,0,0,0.3);"></div>`,
                    iconSize: [20, 20],
                    iconAnchor: [10, 10]
                });

                const marker = L.marker([cctv.lat, cctv.lng], { icon: customIcon }).addTo(map);

                const popupContent = `
                    <div class="custom-popup">
                        <h3>${cctv.name}</h3>
                        <p><strong>Lokasi:</strong> ${cctv.location}</p>
                        <p><strong>Status:</strong> <span style="color: ${iconColor}; font-weight: bold;">${cctv.status.toUpperCase()}</span></p>
                        ${cctv.status === 'online' && cctv.streamUrl ? 
                            `<button class="watch-btn" onclick="playVideo('${cctv.id}')">üî¥ Tonton Live</button>` : 
                            '<p style="color: red;">Stream tidak tersedia</p>'
                        }
                    </div>
                `;

                marker.bindPopup(popupContent);
                marker.on('click', () => selectCctv(cctv.id));
                
                filteredMarkers.push(marker);
            });

            markers = filteredMarkers;
        }

        // Notification system
        function showNotification(message, type = 'info') {
            // Create notification element
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#28a745' : type === 'error' ? '#dc3545' : '#17a2b8'};
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 4px 15px rgba(0,0,0,0.2);
                z-index: 3000;
                font-weight: bold;
                animation: slideInRight 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;

            // Add animation keyframes
            if (!document.querySelector('#notification-styles')) {
                const style = document.createElement('style');
                style.id = 'notification-styles';
                style.textContent = `
                    @keyframes slideInRight {
                        from { transform: translateX(100%); opacity: 0; }
                        to { transform: translateX(0); opacity: 1; }
                    }
                    @keyframes slideOutRight {
                        from { transform: translateX(0); opacity: 1; }
                        to { transform: translateX(100%); opacity: 0; }
                    }
                `;
                document.head.appendChild(style);
            }

            document.body.appendChild(notification);

            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.style.animation = 'slideOutRight 0.3s ease';
                setTimeout(() => {
                    if (document.body.contains(notification)) {
                        document.body.removeChild(notification);
                    }
                }, 300);
            }, 4000);
        }

        // Map controls enhancement
        function addMapControls() {
            // Add custom zoom control
            const zoomToAllButton = L.control({position: 'topleft'});
            zoomToAllButton.onAdd = function(map) {
                const div = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
                div.innerHTML = 'üè†';
                div.style.backgroundColor = 'white';
                div.style.width = '30px';
                div.style.height = '30px';
                div.style.lineHeight = '30px';
                div.style.textAlign = 'center';
                div.style.cursor = 'pointer';
                div.title = 'Zoom ke semua CCTV';
                
                div.onclick = function() {
                    if (cctvData.length > 0) {
                        const group = new L.featureGroup(markers);
                        map.fitBounds(group.getBounds().pad(0.1));
                    }
                };
                
                return div;
            };
            zoomToAllButton.addTo(map);
        }

        // Initialize map controls after map is ready
        setTimeout(addMapControls, 1000);

        // Stream status checker
        async function checkStreamStatus() {
            if (!authToken || !currentUser || currentUser.role !== 'admin') return;

            cctvData.forEach(async (cctv, index) => {
                if (cctv.streamUrl) {
                    try {
                        const response = await fetch(cctv.streamUrl, { method: 'HEAD' });
                        const newStatus = response.ok ? 'online' : 'offline';
                        
                        if (cctvData[index].status !== newStatus) {
                            cctvData[index].status = newStatus;
                            
                            // Update in database
                            await apiRequest(`/cameras/${cctv.id}`, {
                                method: 'PUT',
                                body: JSON.stringify({
                                    ...cctv,
                                    latitude: cctv.lat,
                                    longitude: cctv.lng,
                                    status: newStatus
                                }),
                            });
                        }
                    } catch (error) {
                        console.log(`Stream check failed for ${cctv.name}:`, error);
                        // Keep current status on error
                    }
                }
            });
            
            renderCctvList();
            addMarkersToMap();
        }

        // Check stream status every 5 minutes (only for admin)
        setInterval(checkStreamStatus, 300000);

        // Welcome message
        setTimeout(() => {
            if (!authToken) {
                showNotification('üèôÔ∏è Selamat datang di Sistem CCTV Monitoring Banda Aceh! Silakan login untuk mengakses.', 'info');
            } else {
                showNotification('üèôÔ∏è Selamat datang kembali di Sistem CCTV Monitoring Banda Aceh!', 'info');
            }
        }, 1000);

        // Performance monitoring
        function logPerformance() {
            console.log('üéØ CCTV Monitoring System loaded successfully');
            console.log(`üìä Total CCTV: ${cctvData.length}`);
            console.log(`‚úÖ Online CCTV: ${cctvData.filter(c => c.status === 'online').length}`);
            console.log(`‚ùå Offline CCTV: ${cctvData.filter(c => c.status === 'offline').length}`);
            console.log('üîó Database integration active');
        }

        setTimeout(logPerformance, 2000);
    </script>
</body>
</html>